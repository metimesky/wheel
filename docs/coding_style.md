> 本页面规定 Wheel 在编写过程中需要遵循的规则，以及编码中的一些约定。

# 代码文件组织结构

编写 Wheel 的过程中，我曾多次改变代码文件的组织方式。虽然文件组织方式和 OS 的功能并无过多关系，但我希望 Wheel 的代码用一种清晰的方式组织起来，这样整个系统的架构会更加清晰，管理也更方便。

操作系统是一个复杂的东西，内部组件的耦合度很高，不能很容易地分解成若干独立组件。目前的代码组织方式可能只是暂时的，今后的某个版本可能还会重新组织，但至少，目前的组织方式是目前我认为最合适的。

## 目录结构

首先最外层，是目录 `kernel` 和 `docs`，用于保存内核代码与文档。当 Wheel 支持用户程序之后，还会加入 `user` 目录。除了这两个目录，还有一些说明和脚本文件。由于目前的 Wheel 只有内核部分，所以所有当前代码都在 `kernel` 目录下。

## 内核代码结构

内核使用 C 语言和汇编写成，在文件组织上尽可能的模块化。目前的结构如下：

```
kernel/
├── common/
├── driver/
│   ├── acpi/
│   ├── console/
│   └── serial/
├── init/
├── interrupt/
├── library/
└── memory/
```

其中 `common` 目录存放一些全局的头文件，例如 Multiboot、编译器标准头文件等。`driver` 又分为一些子目录，存放相应设备驱动（这里多说一句，这些驱动会直接编译到内核中，因此只包含最基础的和必要的驱动，其他驱动会在今后实现为内核模块）。`init` 是内核最初开始运行的部分，`boot.asm` 和 `init.c` 就放在这里，实现初始化之后，内核的功能就剩下被动的响应事件和处理请求了。`interrupt` 是实现中断和异常处理的地方，包含 IDT 中设置的中断入口的定义，但是真正的中断和异常处理是在其他模块中的，例如分页异常就需要在内存管理模块中实现，因此 `interrupt` 模块允许其他模块注册中断处理函数。`memory` 是内存管理器，包含物理内存管理和虚拟内存管理（slab 分配器）两部分。`library` 是一个工具库，里面定义了一些方便实用的函数，其他模块可以使用。

目前 Wheel 的功能还不完善，从上面的文件结构应该能看出，目前 Wheel 不支持进程、文件系统、网络等。这些内容将会在以后添加。

## 模块化

按照上面的文件结构，大致上将内核划分成了不同的模块，每个模块相对独立，模块之间有明确定义的接口。习惯上，每个模块都提供一个以模块名字命名的头文件，里面定义的函数就是这个模块公开的接口。由于 Wheel 是我一个人开发的，所以接口的定义不需要那么严谨，也不需要保持稳定，只要模块之间能够相互调用就行。

每个模块的目录中，都包含自身的头文件和源文件。Wheel 并没有把头文件统一放在一个地方，因此在引用其他模块的时候，需要指定绝对路径，如：

``` c
#include <interrupt/interrupt.h>
```

## 目前的问题

这种文件组织方式有几个小问题。`library` 这部分似乎有些尴尬，因为内核库的统一头文件放在了 `common` 下面。此外 `library` 中一些字符串处理函数的效率略低，可以使用汇编重写。

# 代码风格

## 命名

Wheel 的变量/函数命名风格模仿 Linux，使用完整的单词，全小写，单词之间使用下划线连接。对于类型，使用 `_t` 结尾。

对于常量，使用全大写的完整单词，单词之间同样使用下划线连接。

代码文件名全小写，C 语言源程序的后缀名 `*.c`，头文件后缀 `*.h`，汇编文件后缀 `*.asm`。

对于 C 语言头文件，使用 Define-Guard 保护其中的内容。头文件只包含声明，所有的实现都写在 C 或汇编语言源文件里。

## 缩进、换行与空白

缩进使用 4 个空格，没有不能超过 80 列的限制，但是过长的行最好折行显示。

所有的大括号都写在同一行，起始大括号之前加一个空格。其他风格类似 Java。

## 类型系统

Wheel 使用 C 语言编译器的 freestanding 头文件，其中有标准整数类型的定义，如 `int32_t`、`uint64_t` 等。在内核中，优先使用这些类型表示整数，因为能直观地看出占用多少字节的存储空间。

## 例外情况

ACPI 驱动使用第三方模块 ACPICA 实现，因此其中的代码不遵循以上规则。由于 Wheel 只是使用 ACPICA，并不会对 ACPICA 的代码进行大改，因此这种不一致的风格并没有太坏的影响。

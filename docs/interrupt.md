# 中断处理

老原曾说，中断是操作系统的灵魂所在，因此中断处理也是 Wheel 的重要组成部分。Wheel 的中断处理相关代码保存在 `interrupt` 目录下。

## APIC vs 8259A

Wheel 的设计目标之一就是使用最新的硬件标准，因此对于中断处理，Wheel 使用 APIC 替代许多 hobbyOS 中用的 8259A。但是要明白，对一个 OS 来说，中断包括传统意义上的外部中断和内部异常， APIC 和 8259A 仅仅是控制外部中断而已，内部中断和异常的处理方式不变。IDT 和中断处理函数都和以前相同。

## 中断机制

这里说的中断包括中断和异常，处理中断要用到 IDT。64 位模式下的 IDT 表项是 128 位的，包含各个向量号的中断的入口地址，入口函数定义在汇编文件 `entries.asm` 中。

目前 Wheel 还没有实现用户进程，所有的代码都是运行在特权模式下，这种情况下中断的发生相对简单。但是如果 CPU 运行在 ring3 时发生中断，就会发生一次特权级切换，也会带来堆栈的切换。对于一个进程来说，包含用户栈和内核栈，但是处理中断用的内核栈是不属于任何一个进程的，最合理的情况就是把 Wheel 启动过程中用的内核栈当做中断处理用的栈。

### Long-Mode Interrupt Control Transfers

中断发生的时候，假设已经切换到内核栈，CPU 会把一些信息压栈。这些信息并不能包含全部上下文，因此需要进行大量 push，将所有的进程 context 保存在中断栈上。

长方式的 IDT 中只能放 64 位的中断门和陷阱门，中断或异常发生的时候，CPU 首先根据 IDTR 找到相应的 IDT 表项。IDT 表项中含有一个段选择子和一个线性地址，段选择子指用来进行特权检查，门描述符中的线性地址唯一决定中断处理函数的位置。

下面开始对栈进行操作：
1. 首先将 RSP 低 4 位清零，将堆栈按 16 字节对齐
2. 若门描述符的 IST 字段非零，将 RSP 置为 IST 的值
3. 如果发生了特权级切换，从 TSS 中读出目标特权级的 RSP（切换堆栈，只能向内层切换），并且置 SS=NULL
5. 将当前的 SS:RSP 压栈，保存旧的栈帧（其中 SS 补 6 个字节）
6. 将 rflags 压栈，清 TF、NT、RF 位，若是中断门，IF 清零，如果是陷阱门，IF 保持
7. 将返回地址 CS:RIP 压栈，其中 CS 补 6 个字节，构成完整的 64 位整数
8. 如果有的话，将错误码压栈
9. 加载 IDT 表项中的 CS 选择子，加载目标 RIP，开始执行处理程序

上面的步骤中，每次堆栈操作都是 8 字节的整数倍，并且保证 16 字节对齐（加上错误码之后是对齐的，因此 Wheel 对于没有错误码的中断，会手动压栈一个虚拟错误码）。

堆栈切换的时候，只从 TSS 中读取 RSP，SS 却置为零，这样做是为了方便中断的嵌套。

另一个新鲜的地方是 IST。IST 是门描述符中的一个字段，可以精确决定中断处理程序的 RSP 取值。但是 IST 的取值需要保存在 TSS 中，而且最多只有 7 个，因此是有限的。（似乎 IST 是为了让 OS 能够重用以前的代码，在 Wheel 里面意义不大）

### 从中断返回

64 位模式下返回中断使用 iret 指令。

### 中断嵌套

64 位模式下，如果中断发生了特权级切换，那么就会将 SS 置为 NULL。如果此时又发生了一次中断，就会导致为零的 SS 被压栈。执行 iret 返回的时候，就会给 SS 加载 NULL。理论上，加载空选择子会导致 #GP，但是在 64 位模式下，如果返回目标的特权级不是 3 并且目标也是 64 位模式，则不会产生 #GP，而是告诉 CPU，这只是一个内嵌的中断的返回。

利用这个特点能做什么事情呢，因为中断处理函数是我们自己编写的，可以接受中断时压栈的参数，因此可以根据 SS 的值判断我们这次中断从何而来，是把用户进程（ring3）中断了，还是把中断给中断了。

单纯利用这个特点判断中断来源于内核还是用户应该是不够的。因为如果从内核模式中断，正常的非零的 SS 也会被压栈。不过判断来源有更简单的方法，直接检测压栈的 SS 的末两位就可以，如果是 3，则表示从用户程序中断。

### TSS

似乎能从上面的描述中看出，如果想实现用户层软件，就需要一个 TSS。TSS 是一个特殊的段，在 GDT 中有一个条目，TR 寄存器保存这个条目的选择子。

TSS 的结构很复杂，但是并不乱，大部分条目都是用不到的。但是需要在 boot.asm 中修改 GDT 的定义，为 TSS 段描述符留出空间。

## 外部中断

这里需要对外部中断多说几句。外部中断的分派通过 APIC 控制，外部中断处理完成之后需要发送 EOI 来通知 APIC，中断已经处理完。
